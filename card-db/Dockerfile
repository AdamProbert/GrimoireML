FROM python:3.12-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app ./app

ENV PYTHONUNBUFFERED=1
ENV APP_ENV=production
ENV REDIS_URL=redis://redis:6379/0
ENV IMAGE_CACHE_TTL=86400
ENV IMAGE_NEG_CACHE_TTL=300
ENV IMAGE_FETCH_TIMEOUT=10
ENV IMAGE_DOWNLOAD_TIMEOUT=15
ENV IMAGE_FETCH_RETRIES=3
ENV IMAGE_RETRY_BACKOFF_BASE=0.2
ENV IMAGE_CONCURRENCY_LIMIT=25
ENV IMAGE_CIRCUIT_THRESHOLD=20
ENV IMAGE_CIRCUIT_WINDOW_SECONDS=60
ENV IMAGE_CIRCUIT_OPEN_SECONDS=30

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8081"]
